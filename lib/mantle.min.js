/*
Mantle
Copyright (c) 2013 Vince Allen
vince@vinceallen.com
http://www.vinceallen.com

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/
/* Version: 1.1.0 */
/* Build time: April 27, 2013 10:28:51 */

function Mantle(e,q){function n(a){this.options=a||{};this.name=this.options.name||"Element";this.id=this.name+e.System._getNewId();return this}function f(a,b){this.x=a||0;this.y=b||0}function l(){}function m(){var a,b;this._active=!0;this._fps=0;this._timeLastSecond=this._timeLastFrame=this._time=Date.now?Date.now():0;this._frameCount=0;this._el=document.createElement("div");this._el.id="statsDisplay";this._el.className="statsDisplay";this._el.style.color="white";this._fpsValue=this._totalElementsValue=
null;a=document.createElement("span");a.className="statsDisplayLabel";b=document.createTextNode("trans3d: ");a.appendChild(b);this._el.appendChild(a);this._3dTransformsValue=document.createTextNode(e.System.supportedFeatures.csstransforms3d);this._el.appendChild(this._3dTransformsValue);a=document.createElement("span");a.className="statsDisplayLabel";b=document.createTextNode("total elements: ");a.appendChild(b);this._el.appendChild(a);this._totalElementsValue=document.createTextNode("0");this._el.appendChild(this._totalElementsValue);
a=document.createElement("span");a.className="statsDisplayLabel";b=document.createTextNode("fps: ");a.appendChild(b);this._el.appendChild(a);this._fpsValue=document.createTextNode("0");this._el.appendChild(this._fpsValue);document.body.appendChild(this._el);this._update(this)}function d(){this.name="system"}function i(a){if(!a||"object"!==e.Utils.getDataType(a))throw Error('World: A valid DOM object is required for the new World\'s "el" property.');this.el=a;this.name="world";this.id=this.name+e.System._getNewId();
this.bounds=this._getBounds();this.pauseDraw=this.pauseStep=!1;this.style={};this.gravity=new e.Vector(0,1);this.c=0.1;this.position="absolute";this.left=this.top=0;this.location=new e.Vector;this.opacity=1;this.visibility="visible";this.angle=0;this.scale=1;this.color="transparent";this.borderColor="white";this.borderStyle="solid";this.borderWidth="1";this.world={};this._pool=[]}var p=q||null;window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||
window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)};e.PubSub={subscribe:function(a,b){this._callbacks||(this._callbacks={});(this._callbacks[a]||(this._callbacks[a]=[])).push(b);return this},publish:function(){var a=Array.prototype.slice.call(arguments,0),b=a.shift(),c,d;if(!this._callbacks||!(c=this._callbacks[b]))return this;b=0;for(d=c.length;b<d;b+=1)c[b].apply(this,a);return this}};e.Utils={addEvent:function(a,b,c){a.addEventListener?this.addEventHandler=
function(a,b,c){a.addEventListener(b,c,!1)}:a.attachEvent&&(this.addEventHandler=function(a,b,c){a.attachEvent("on"+b,c)});this.addEventHandler(a,b,c)},getRandomNumber:function(a,b,c){return c?Math.random()*(b-(a-1))+a:Math.floor(Math.random()*(b-(a-1)))+a},getWindowSize:function(){var a={width:!1,height:!1};"undefined"!==typeof window.innerWidth?a.width=window.innerWidth:"undefined"!==typeof document.documentElement&&"undefined"!==typeof document.documentElement.clientWidth?a.width=document.documentElement.clientWidth:
"undefined"!==typeof document.body&&(a.width=document.body.clientWidth);"undefined"!==typeof window.innerHeight?a.height=window.innerHeight:"undefined"!==typeof document.documentElement&&"undefined"!==typeof document.documentElement.clientHeight?a.height=document.documentElement.clientHeight:"undefined"!==typeof document.body&&(a.height=document.body.clientHeight);return a},clone:function(a){function b(){}b.prototype=a;return new b},extend:function(a,b){function c(){}c.prototype=b.prototype;a.prototype=
new c;a.prototype.constructor=a},getDataType:function(a){return"[object Array]"===Object.prototype.toString.call(a)?"array":"[object NodeList]"===Object.prototype.toString.call(a)?"nodeList":typeof a}};n.prototype._init=function(){var a,b=this.options;if(!b.world||"object"!==e.Utils.getDataType(b.world))throw Error("Element: A valid world object is required for a new Element.");for(a in b)b.hasOwnProperty(a)&&(this[a]="function"===e.Utils.getDataType(b[a])?b[a]():b[a]);this._el.style.top=0;this._el.style.left=
0};n.prototype.draw=function(){var a,b=this._el;b&&(a=this._getCSSText({x:this.location.x-this.width/2,y:this.location.y-this.height/2,width:this.width,height:this.height,color:this.color,visibility:this.visibility}),b.style.cssText=a);return a};n.prototype._getCSSText=function(a){var b;b=e.System;b=b.supportedFeatures.csstransforms3d?["-webkit-transform: translate3d("+a.x+"px, "+a.y+"px, 0)","-moz-transform: translate3d("+a.x+"px, "+a.y+"px, 0)","-o-transform: translate3d("+a.x+"px, "+a.y+"px, 0)",
"-ms-transform: translate3d("+a.x+"px, "+a.y+"px, 0)"].join(";"):b.supportedFeatures.csstransforms?["-webkit-transform: translateX("+a.x+"px) translateY("+a.y+"px)","-moz-transform: translateX("+a.x+"px) translateY("+a.y+"px)","-o-transform: translateX("+a.x+"px) translateY("+a.y+"px)","-ms-transform: translateX("+a.x+"px) translateY("+a.y+"px)"].join(";"):["position: absolute","left: "+a.x+"px","top: "+a.y+"px"].join(";");a.background="array"===e.Utils.getDataType(a.color)?"rgb("+a.color[0]+", "+
a.color[1]+", "+a.color[2]+")":"transparent";return[b,"width: "+a.width+"px","height: "+a.height+"px","background-color: "+a.background,"visibility: "+a.visibility].join(";")};e.Element=n;f.VectorSub=function(a,b){return new f(a.x-b.x,a.y-b.y)};f.VectorAdd=function(a,b){return new f(a.x+b.x,a.y+b.y)};f.VectorMult=function(a,b){return new f(a.x*b,a.y*b)};f.VectorDiv=function(a,b){return new f(a.x/b,a.y/b)};f.VectorDistance=function(a,b){return Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2))};f.VectorMidPoint=
function(a,b){return f.VectorAdd(a,b).div(2)};f.VectorAngleBetween=function(a,b){var c=a.dot(b);return Math.acos(c/(a.mag()*b.mag()))};f.prototype.name="Vector";f.prototype.clone=function(){function a(){}a.prototype=this;return new a};f.prototype.add=function(a){this.x+=a.x;this.y+=a.y;return this};f.prototype.sub=function(a){this.x-=a.x;this.y-=a.y;return this};f.prototype.mult=function(a){this.x*=a;this.y*=a;return this};f.prototype.div=function(a){this.x/=a;this.y/=a;return this};f.prototype.mag=
function(){return Math.sqrt(this.x*this.x+this.y*this.y)};f.prototype.limit=function(a){this.mag()>a&&(this.normalize(),this.mult(a));return this};f.prototype.normalize=function(){var a=this.mag();if(0!==a)return this.div(a)};f.prototype.distance=function(a){return Math.sqrt(Math.pow(a.x-this.x,2)+Math.pow(a.y-this.y,2))};f.prototype.rotate=function(a){var b=Math.cos(a),a=Math.sin(a),c=this.x,d=this.y;this.x=c*b-d*a;this.y=c*a+d*b;return this};f.prototype.midpoint=function(a){return f.VectorAdd(this,
a).div(2)};f.prototype.dot=function(a){return this.z&&a.z?this.x*a.x+this.y*a.y+this.z*a.z:this.x*a.x+this.y*a.y};e.Vector=f;l.detect=function(a){return!this[a]?!1:this[a].call(this)};l.csstransforms=function(){var a=document.createDocumentFragment(),b=document.createElement("div");a.appendChild(b);b.style.cssText="-webkit-transform: translateX(1px) translateY(1px);-moz-transform: translateX(1px) translateY(1px);-o-transform: translateX(1px) translateY(1px);-ms-transform: translateX(1px) translateY(1px)";
for(var a=[b.style.transform,b.style.webkitTransform,b.style.MozTransform,b.style.OTransform,b.style.msTransform],b=!1,c=0;c<a.length;c+=1)if(a[c]){b=!0;break}return b};l.csstransforms3d=function(){var a=document.createDocumentFragment(),b=document.createElement("div");a.appendChild(b);b.style.cssText="-webkit-transform: translate3d(1px, 1px, 0);-moz-transform: translate3d(1px, 1px, 0);-o-transform: translate3d(1px, 1px, 0);-ms-transform: translate3d(1px, 1px, 0)";for(var a=[b.style.transform,b.style.webkitTransform,
b.style.MozTransform,b.style.OTransform,b.style.msTransform],b=!1,c=0;c<a.length;c+=1)if(a[c]){b=!0;break}return b};l.touch=function(){var a=document.createElement("div");a.setAttribute("ongesturestart","return;");return"function"===typeof a.ongesturestart?!0:!1};e.FeatureDetector=l;m.prototype.getFPS=function(){return this._fps};m.prototype._update=function(a){var b=e.System.count();a._time=Date.now?Date.now():0;a._frameCount++;a._time>a._timeLastSecond+1E3&&(a._fps=a._frameCount,a._timeLastSecond=
a._time,a._frameCount=0,a._fpsValue.nodeValue=a._fps,a._totalElementsValue.nodeValue=b,a._3dTransformsValue.nodeValue=e.System.supportedFeatures.csstransforms3d);var c=this;this._active&&window.requestAnimFrame(function(){c._update(c)})};m.prototype.destroy=function(){this._active=!1;document.getElementById(this._el.id)&&document.body.removeChild(this._el)};m.prototype.name="StatsDisplay";e.StatsDisplay=m;d._records={lookup:{},list:[]};d._worldsCache={lookup:{},list:[]};d._Caches={};d._idCount=0;
d.mouse={location:new e.Vector,lastLocation:new e.Vector,velocity:new e.Vector};d._resizeTime=0;d.create=function(a,b,c,h){var o,j=this._records.list,a=a||function(){},f,g=e.Utils,k=d.allWorlds(),i=d._worldsCache.lookup;d._setup=a;d._worlds=b;d._noStart=h;if(c)if("object"===g.getDataType(c))this.supportedFeatures=c;else throw Error("System: supportedFeatures should be passed as an object.");else this.supportedFeatures=d._getSupportedFeatures();if(b)if("object"===g.getDataType(b))j[j.length]=new e.World(b),
k[k.length]=j[j.length-1],i[k[k.length-1].id]=!0;else{if("array"===g.getDataType(b)&&b.length){c=0;for(o=b.length;c<o;c++)if((f=b[c])&&"object"===g.getDataType(f))j[j.length]=new e.World(f),k[k.length]=j[j.length-1],i[k[k.length-1].id]=!0}}else j[j.length]=new e.World(document.body),k[k.length]=j[j.length-1],i[k[k.length-1].id]=!0;"function"===g.getDataType(a)&&a.call(this);h||this._update();e.Utils.addEvent(document,"mousemove",function(a){d._recordMouseLoc.call(d,a)});e.Utils.addEvent(window,"touchstart",
function(a){d._recordMouseLoc.call(d,a)});e.Utils.addEvent(window,"touchmove",function(a){d._recordMouseLoc.call(d,a)});e.Utils.addEvent(window,"touchend",function(a){d._recordMouseLoc.call(d,a)});e.Utils.addEvent(window,"resize",function(a){d._resize.call(d,a)});return d.allElements()};d._getNewId=function(){this._idCount++;return this._idCount};d._getIdCount=function(){return this._idCount};d._update=function(){var a,b,c=this.allElements(),d=this.allWorlds();if(this._resizeTime&&100<(new Date).getTime()-
this._resizeTime){a=this._resizeTime=0;for(b=d.length;a<b;a+=1)d[a].pauseStep=!1}for(a=c.length-1;0<=a;a-=1)b=c[a],b.step&&!b.world.pauseStep&&b.step();for(a=c.length-1;0<=a;a-=1)b=c[a],b.draw&&!b.world.pauseDraw&&b.draw();var e=this;window.requestAnimFrame(function(){e._update(e)})};d.getWorld=function(a){for(var b=this._records.list,c=0,d=b.length;c<d;c++)if(b[c].el===a)return b[c];return null};d.allWorlds=function(){return this._worldsCache.list};d.hasWorld=function(a){return d._worldsCache.lookup[a]};
d.start=function(){this._update()};d.updateCache=function(a){var b=d._Caches[a.name]||(d._Caches[a.name]={lookup:{},list:[]});b.list[b.list.length]=a;b.lookup[a.id]=!0;return b};d._updateCacheLookup=function(a,b){var c=d._Caches[a.name];c&&(c.lookup[a.id]=b)};d.add=function(a,b){var c=b||{},h=this.allElements(),o=this._records.lookup,j=null;c.world=!c.world||"object"!==e.Utils.getDataType(c.world)?h[0]:d.getWorld(c.world.el);if(this.getAllElementsByName(a,c.world._pool).length)for(var f=0,g=c.world._pool.length;f<
g;f++){if(c.world._pool[f].name===a){h[h.length]=c.world._pool.splice(f,1)[0];h[h.length-1].options=c;d._updateCacheLookup(h[h.length-1],!0);break}}else h[h.length]=p&&p[a]?new p[a](c):new e[a](c);h[h.length-1]._init&&h[h.length-1]._init();h[h.length-1]._el&&(j=h[h.length-1]._el.parentNode);o[h[h.length-1].id]=j;return this.lastElement()};d.count=function(){return this._records.list.length};d.hasElement=function(a){return d._records.lookup[a]};d.allElements=function(){return this._records.list};d.firstElement=
function(){return this._records.list[0]};d.lastElement=function(){return this._records.list[this._records.list.length-1]};d.getAllElementsByName=function(a,b){var c,d,e=[],f=b||this._records.list;c=0;for(d=f.length;c<d;c++)f[c].name===a&&(e[e.length]=f[c]);return e};d.getAllElementsByAttribute=function(a,b){var c,d,e=[],f=void 0!==b?b:null;c=0;for(d=this._records.list.length;c<d;c++)void 0!==this._records.list[c][a]&&!(null!==f&&this._records.list[c][a]!==f)&&(e[e.length]=this._records.list[c]);return e};
d.updateElementPropsByName=function(a,b){var c,d,e,f=this.getAllElementsByName(a);c=0;for(d=f.length;c<d;c++)for(e in b)b.hasOwnProperty(e)&&(f[c][e]=b[e]);return f};d.getElement=function(a){var b,c,d=this._records;b=0;for(c=d.list.length;b<c;b+=1)if(d.list[b].id===a)return d.list[b];return null};d.updateElement=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a};d.destroyElement=function(a){var b,c,e=this._records.list;b=0;for(c=e.length;b<c;b+=1)if(e[b].id===a.id){e[b]._el.style.visibility=
"hidden";e[b]._el.style.top="-5000px";e[b]._el.style.left="-5000px";e[b].world._pool[e[b].world._pool.length]=e.splice(b,1)[0];d._updateCacheLookup(a,!1);break}};d._getSupportedFeatures=function(){return window.Modernizr?{csstransforms3d:Modernizr.csstransforms3d,csstransforms:Modernizr.csstransforms}:{csstransforms3d:e.FeatureDetector.detect("csstransforms3d"),csstransforms:e.FeatureDetector.detect("csstransforms")}};d._recordMouseLoc=function(a){var b;this.mouse.lastLocation.x=this.mouse.location.x;
this.mouse.lastLocation.y=this.mouse.location.y;a.changedTouches&&(b=a.changedTouches[0]);a.pageX&&a.pageY?(this.mouse.location.x=a.pageX,this.mouse.location.y=a.pageY):a.clientX&&a.clientY?(this.mouse.location.x=a.clientX,this.mouse.location.y=a.clientY):b&&(this.mouse.location.x=b.pageX,this.mouse.location.y=b.pageY);this.mouse.velocity.x=this.mouse.lastLocation.x-this.mouse.location.x;this.mouse.velocity.y=this.mouse.lastLocation.y-this.mouse.location.y;return this.mouse};d._resize=function(){var a,
b,c,d=this.allElements(),f;a=e.Utils.getWindowSize();var j=a.width,i=a.height,g=this.allWorlds();this._resizeTime=(new Date).getTime();a=0;for(b=g.length;a<b;a+=1)g[a].pauseStep=!0;a=0;for(b=d.length;a<b;a+=1)f=d[a],"world"!==f.name&&(c=f.location,f=f.world,c&&(c.x=j*(c.x/f.bounds[1]),c.y=i*(c.y/f.bounds[2])));a=0;for(b=g.length;a<b;a+=1)g[a].bounds=g[a]._getBounds()};d._pause=function(a){var b,c=[];a?"object"===e.Utils.getDataType(a)?c.push(d.getWorld(c)):"array"===e.Utils.getDataType(a)&&(c=a):
c=d.allWorlds();a=0;for(b=c.length;a<b;a++)c[a].pauseStep=!c[a].pauseStep,c[a].pauseDraw=!c[a].pauseDraw};d._resetSystem=function(){d._destroySystem(!0);d._setup.call(d)};d._destroyAllElements=function(){var a,b=d.allElements();for(a=b.length-1;0<=a;a--)d.hasWorld([b[a].id])||b.splice(a,1)};d._destroySystem=function(a){var b,c,f=d.allWorlds();d.allElements();var i=a||!1,a=0;for(b=f.length;a<b;a++){f[a].pauseStep=!1;f[a].pauseDraw=!1;for(c=f[a].el;c.firstChild;)c.removeChild(c.firstChild);i||c.parentNode.removeChild(c)}i?
d._destroyAllElements():(d._records={lookup:{},list:[]},d._worldsCache={lookup:{},list:[]},d._idCount=0);d.mouse={location:new e.Vector,lastLocation:new e.Vector,velocity:new e.Vector};d._resizeTime=0;d._statsDisplay&&(d._statsDisplay.destroy(),d._statsDisplay=null)};d._stats=function(){d._statsDisplay?(d._statsDisplay.destroy(),d._statsDisplay=null):d._statsDisplay=new e.StatsDisplay};e.PubSub.subscribe("pause",d._pause);e.PubSub.subscribe("resetSystem",d._resetSystem);e.PubSub.subscribe("destroyAllElements",
d._destroyAllElements);e.PubSub.subscribe("destroySystem",d._destroySystem);e.PubSub.subscribe("stats",d._stats);e.PubSub.subscribe("UpdateCache",d.updateCache);e.System=d;i.prototype.step=function(){};i.prototype.draw=function(){var a,b=this.el;b&&(a=this._getCSSText({x:this.location.x,y:this.location.y,width:this.bounds[1],height:this.bounds[2],opacity:this.opacity,visibility:this.visibility,a:this.angle,s:this.scale,color:this.color,borderColor:this.borderColor,borderStyle:this.borderStyle,borderWidth:this.borderWidth}),
b.style.cssText=a);return a};i.prototype._getCSSText=function(a){var b=e.System;return[b.supportedFeatures.csstransforms3d?["-webkit-transform: translate3d("+a.x+"px, "+a.y+"px, 0) rotate("+a.a+"deg) scaleX("+a.s+") scaleY("+a.s+")","-moz-transform: translate3d("+a.x+"px, "+a.y+"px, 0) rotate("+a.a+"deg) scaleX("+a.s+") scaleY("+a.s+")","-o-transform: translate3d("+a.x+"px, "+a.y+"px, 0) rotate("+a.a+"deg) scaleX("+a.s+") scaleY("+a.s+")","-ms-transform: translate3d("+a.x+"px, "+a.y+"px, 0) rotate("+
a.a+"deg) scaleX("+a.s+") scaleY("+a.s+")"].join(";"):b.supportedFeatures.csstransforms?["-webkit-transform: translateX("+a.x+"px) translateY("+a.y+"px) rotate("+a.a+"deg) scaleX("+a.s+") scaleY("+a.s+")","-moz-transform: translateX("+a.x+"px) translateY("+a.y+"px) rotate("+a.a+"deg) scaleX("+a.s+") scaleY("+a.s+")","-o-transform: translateX("+a.x+"px) translateY("+a.y+"px) rotate("+a.a+"deg) scaleX("+a.s+") scaleY("+a.s+")","-ms-transform: translateX("+a.x+"px) translateY("+a.y+"px) rotate("+a.a+
"deg) scaleX("+a.s+") scaleY("+a.s+")"].join(";"):["position: absolute","left: "+a.x+"px","top: "+a.y+"px"].join(";"),"width: "+a.width+"px","height: "+a.height+"px","opacity: "+a.opacity,"visibility: "+a.visibility,"background-color: "+("rgb("+a.color[0]+", "+a.color[1]+", "+a.color[2]+")"),"border-color: "+("rgb("+a.borderColor[0]+", "+a.borderColor[1]+", "+a.borderColor[2]+")"),"border-style: "+a.borderStyle,"border-width: "+a.borderWidth+"px"].join(";")};i.update=function(a,b){var c,f,i,j,l=e.Utils,
g=[],k="object"===l.getDataType(a)?a:{},m=e.Utils.getWindowSize();if(b)if("object"===l.getDataType(b))g[g.length]=d.getWorld(b);else{if("array"===l.getDataType(b)&&b.length){c=0;for(f=b.length;c<f;c++)j=b[c],"object"===l.getDataType(j)&&(g[g.length]=d.getWorld(j))}}else g[g.length]=e.System._records.list[0];c=0;for(f=g.length;c<f;c++){for(i in k)k.hasOwnProperty(i)&&(g[c][i]=k[i]);g[c]._applyStyles();g[c].bounds=g[c]._getBounds();g[c].location=new e.Vector(m.width/2-g[c].bounds[1]/2,m.height/2-g[c].bounds[2]/
2)}};i.prototype._applyStyles=function(){for(var a in this.style)this.style.hasOwnProperty(a)&&(this.el.style[a]=this.style[a])};i.prototype._getBounds=function(){var a;if(this.width&&this.height)return[0,this.width,this.height,0];a=this.el===document.body?e.Utils.getWindowSize():{width:this.el.offsetWidth,height:this.el.offsetHeight};return[0,a.width,a.height,0]};e.World=i};

